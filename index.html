<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet" />
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/deck.gl-leaflet@latest"></script>

    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/deck.gl/dist.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@deck.gl/leaflet/dist.min.js"></script> -->

    <script src="./js/centerPointGeoJson.js"></script>

    <style>
      #map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
  </body>
  <script>console.log("Leaflet loaded version:", L.version);</script>

  <script type="text/javascript">
    const defaultStyle = {
        fillColor: "#cbc9e2", 
        color: "#9e9ac8",       // Border color
        weight: 1,
        fillOpacity: 0.6
    };

    const hoverStyle = {
        fillColor: "#9e9ac8",
        color: "#9e9ac8",
        weight: 1,
        fillOpacity: 0.8
    };

    const selectedStyle = {
        fillColor: "#54278f", 
        weight: 1
    };

    // Initialize the map
    const map = L.map('map').setView([2.5, 20.0], 4);

    L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/light-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibXdpc2NnIiwiYSI6ImNtN2VtbGEzNzBnaTgyam9vZXl3YzM2Ym4ifQ.YJe4CFT-CEYhl0D98Wk8aw', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    }).addTo(map);

    // Fetch and add GeoJSON data
    fetch("data/WorldPoly.geojson")
      .then(response => response.json())
      .then(data => {
          L.geoJson(data, {
            style: defaultStyle, // Set default style
            onEachFeature: onEachFeature // Attach event listeners 
          }).addTo(map);
      })
      .catch(error => console.error("Error loading GeoJSON:", error));

    // Event functions to apply and remove styles
    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: function (e) {
                e.target.setStyle(hoverStyle); // Apply hover style
            },
            mouseout: function (e) {
                e.target.setStyle(defaultStyle); // Reset to default style
            },
            click: function (e) {
                e.target.setStyle(selectedStyle); // Apply selected style on click
            }
        });

        // Add a popup with country name
        if (feature.properties && feature.properties.ADMIN) {
            layer.bindPopup(`<b>Country:</b> ${feature.properties.ADMIN}`);
        }
    }

    async function fetchWikidataGeoJSON() {
        const response = await fetch('./data/countryCenterPoints.geojson');
        return await response.json();
    }

    function getCoordinatesByISO3(geojsonData, iso3) {
        for (let feature of geojsonData.features) {
            if (feature.properties.iso3166_3 === iso3) {
                                return feature.geometry.coordinates;
            }
        }
        return null; // If no matching ISO3 code found
    }

    // Fetch and add country center points
    async function getCountryCenterPoints() {
        try {
            const geoJSON = await fetchWikidataGeoJSON(); // Fetch data from centerPointGeoJson.js
            return geoJSON;
        } catch (error) {
            console.error("Error loading country centerpoints:", error);
        }
    }

    async function countryCentroidsGeoJSON() {
        const centroid = await getCountryCenterPoints();
        return centroid;
    }

    countryCentroidsGeoJSON().then(countryCentroids => {
        const startingPoint = getCoordinatesByISO3(countryCentroids, "GBR");

        const countryList = ["FRA", "USA"];
        const endingPoints = [];

        // Loop over each country ISO3 code and push its coordinates into endingPoints
        countryList.forEach(countryCode => {
            const coordinates = getCoordinatesByISO3(countryCentroids, countryCode);
            if (coordinates) {
                endingPoints.push(coordinates);
            }
        });

        console.log("Starting Point:", startingPoint);
        console.log("Ending Points:", endingPoints);

        // Prepare ArcLayer data
        const arcData = endingPoints.map(endPoint => ({
            sourcePosition: startingPoint,
            targetPosition: endPoint
        }));

        // Create the ArcLayer
        const arcLayer = new deck.ArcLayer({
            id: 'arc-layer',
            data: arcData,
            getSourcePosition: d => d.sourcePosition,
            getTargetPosition: d => d.targetPosition,
            getWidth: 2,
            getSourceColor: [255, 140, 0], // Orange color
            getTargetColor: [0, 255, 255], // Cyan color
        });

        // Integrate with Leaflet
        const deckOverlay = new deck.DeckGL({
            layers: [arcLayer],
            initialViewState: {
                longitude: startingPoint[0],
                latitude: startingPoint[1],
                zoom: 3,
                pitch: 30
            },
            getTooltip: ({ object }) =>
                object && `From: GBR\nTo: ${object.targetPosition}`,
        });

        L.deckGL(deckOverlay).addTo(map);
    });
  </script>
</html>